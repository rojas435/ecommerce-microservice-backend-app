---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: observability
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      scrape_timeout: 10s
      evaluation_interval: 15s

    rule_files:
      - /etc/prometheus/alerting-rules.yml

    alerting:
      alertmanagers:
        - static_configs:
            - targets:
                - alertmanager:9093

    scrape_configs:
      - job_name: "prometheus"
        static_configs:
          - targets: ["prometheus:9090"]

      - job_name: "grafana"
        static_configs:
          - targets: ["grafana:3000"]

      - job_name: "zipkin"
        metrics_path: /actuator/prometheus
        static_configs:
          - targets: ["zipkin-server:9411"]

      - job_name: "ecommerce-services"
        kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names:
                - ecommerce
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_label_app]
            action: keep
            regex: .+
          - source_labels: [__meta_kubernetes_endpoint_port_name]
            action: keep
            regex: http
          - action: labelmap
            regex: __meta_kubernetes_service_label_(.+)
          - source_labels: [__address__]
            target_label: instance
          - target_label: job
            replacement: ecommerce-service

  alerting-rules.yml: |
    groups:
      - name: availability.rules
        rules:
          - alert: EcommercePodDown
            expr: kube_pod_container_status_ready{namespace="ecommerce"} == 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "Pod {{ $labels.pod }} no está listo"
              description: "La aplicación {{ $labels.pod }} dejó de estar lista por más de 2 minutos."
          - alert: HighHttpErrorRate
            expr: sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) by (app)
                  /
                  sum(rate(http_server_requests_seconds_count[5m])) by (app)
                  > 0.1
            for: 1m
            labels:
              severity: warning
            annotations:
              summary: "Error 5xx elevado en {{ $labels.app }}"
              description: "Más del 10% de las peticiones resultan en error 5xx durante el último minuto."
      - name: business.rules
        rules:
          - alert: OrdersStalled
            expr: rate(order_service_orders_created_total[5m]) < 0.1
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "Flujo de órdenes detenido"
              description: "El servicio de órdenes no está recibiendo órdenes nuevas."
          - alert: PaymentsFailureSpike
            expr: rate(payment_service_payments_failed_total[5m])
                  /
                  rate(payment_service_payments_total[5m])
                  > 0.2
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Pagos fallando en exceso"
              description: "Más del 20% de los pagos están fallando."
