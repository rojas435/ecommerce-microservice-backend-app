---
apiVersion: v1
kind: ConfigMap
metadata:
  name: locustfile
  namespace: ecommerce
data:
  locustfile.py: |
    from locust import HttpUser, task, between
    import random

    class ReadHeavyUser(HttpUser):
        """User that performs read operations - simulates browsing behavior"""
        wait_time = between(1, 3)
        weight = 10  # 100% read-only for now (POST endpoints need debugging)
        
        @task(10)
        def browse_products(self):
            """List all products - most common operation"""
            with self.client.get("/product-service/api/products", name="[Read] Browse Products", catch_response=True) as response:
                if response.status_code == 200:
                    response.success()
                else:
                    response.failure(f"Got status {response.status_code}")
        
        @task(5)
        def view_product(self):
            """View specific product details"""
            # Product IDs typically 1-20 based on seed data
            product_id = random.randint(1, 20)
            with self.client.get(f"/product-service/api/products/{product_id}", name="[Read] View Product", catch_response=True) as response:
                if response.status_code == 200:
                    response.success()
                elif response.status_code == 404:
                    # Product not found is acceptable
                    response.success()
                else:
                    response.failure(f"Got status {response.status_code}")
        
        @task(2)
        def view_orders(self):
            """List orders"""
            with self.client.get("/order-service/api/orders", name="[Read] View Orders", catch_response=True) as response:
                if response.status_code == 200:
                    response.success()
                else:
                    response.failure(f"Got status {response.status_code}")
        
        @task(1)
        def view_favourites(self):
            """List favourites"""
            with self.client.get("/favourite-service/api/favourites", name="[Read] View Favourites", catch_response=True) as response:
                if response.status_code == 200:
                    response.success()
                else:
                    response.failure(f"Got status {response.status_code}")
    
    # NOTE: POST endpoints disabled - they return 400 Bad Request
    # Need to debug payload format before enabling write tests
    # class WriteHeavyUser(HttpUser):
    #     """User that performs write operations"""
    #     wait_time = between(2, 5)
    #     weight = 3
    #     
    #     @task(5)
    #     def create_order(self):
    #         payload = {...}
    #         self.client.post("/order-service/api/orders", json=payload, name="[Write] Create Order")
    #     
    #     @task(3)
    #     def add_favourite(self):
    #         payload = {...}
    #         self.client.post("/favourite-service/api/favourites", json=payload, name="[Write] Add Favourite")

---
apiVersion: batch/v1
kind: Job
metadata:
  name: locust-performance-test
  namespace: ecommerce
spec:
  # Job will be deleted after 1 hour (successful or failed)
  ttlSecondsAfterFinished: 3600
  backoffLimit: 2  # Retry up to 2 times on failure
  
  template:
    metadata:
      labels:
        app: locust-test
    spec:
      restartPolicy: Never
      
      # Init container to wait for API Gateway to be ready
      initContainers:
      - name: wait-for-api-gateway
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "Waiting for API Gateway to be ready..."
          until wget -q -O- http://api-gateway:8080/actuator/health 2>/dev/null | grep -q UP; do
            echo "API Gateway not ready yet, waiting 5s..."
            sleep 5
          done
          echo "API Gateway is ready!"
      
      containers:
      - name: locust
        image: locustio/locust:2.17.0
        
        # Command to run performance test
        command:
        - locust
        - --locustfile=/locust/locustfile.py
        - --host=http://api-gateway:8080
        - --users=100          # Simulate 100 concurrent users
        - --spawn-rate=10      # Spawn 10 users per second
        - --run-time=3m        # Run for 3 minutes
        - --headless           # No web UI (CI/CD mode)
        - --web-port=8089      # Explicit port (prevents K8s env var issues)
        - --html=/reports/performance-report.html
        - --csv=/reports/performance
        - --only-summary       # Print only summary in logs
        
        volumeMounts:
        - name: locustfile
          mountPath: /locust
        - name: reports
          mountPath: /reports
        
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      
      volumes:
      - name: locustfile
        configMap:
          name: locustfile
      - name: reports
        emptyDir: {}
