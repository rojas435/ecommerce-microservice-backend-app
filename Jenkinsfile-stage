pipeline {
  agent {
    kubernetes {
      yaml '''
        apiVersion: v1
        kind: Pod
        metadata:
          namespace: jenkins
        spec:
          serviceAccountName: jenkins-agent
          containers:
          - name: docker
            image: docker:24-dind
            securityContext:
              privileged: true
            env:
            - name: DOCKER_TLS_CERTDIR
              value: ""
            resources:
              requests:
                memory: "512Mi"
                cpu: "500m"
              limits:
                memory: "1Gi"
                cpu: "1000m"
          - name: kubectl
            image: alpine/k8s:1.28.3
            command: ['cat']
            tty: true
            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "256Mi"
                cpu: "200m"
          - name: maven
            image: maven:3.9.9-eclipse-temurin-17
            command: ['sleep']
            args: ['99d']
            resources:
              requests:
                memory: "1Gi"
                cpu: "500m"
              limits:
                memory: "2Gi"
                cpu: "1000m"
      '''
    }
  }
  
  options {
    timeout(time: 60, unit: 'MINUTES')
    buildDiscarder(logRotator(numToKeepStr: '10'))
  }
  
  triggers {
    // Poll SCM every 5 minutes (for local Jenkins without webhooks)
    // Will be triggered automatically from DEV pipeline on success
    pollSCM('H/5 * * * *')
  }
  
  parameters {
    string(name: 'DEV_IMAGE_TAG', defaultValue: '', description: 'Tag de imagen DEV a promover (ej: dev-a1b2c3d)')
    string(name: 'VERSION', defaultValue: '1.0.0', description: 'Versión de STAGE (ej: 1.0.0)')
  }
  
  environment {
    DOCKERHUB_CREDENTIALS = credentials('dockerhub-credentials')
    DOCKERHUB_REPO = 'rojas43529'
    STAGE_TAG = "stage-${params.VERSION}"
    STABLE_TAG = "stable-${params.VERSION}"
  }
  
  stages {
    stage('Validate Parameters') {
      steps {
        script {
          if (!params.DEV_IMAGE_TAG) {
            error "DEV_IMAGE_TAG parameter is required!"
          }
          echo "Promoting images:"
          echo "  FROM: ${params.DEV_IMAGE_TAG}"
          echo "  TO:   ${STAGE_TAG}"
        }
      }
    }

    stage('Re-tag Docker Images to STAGE') {
      parallel {
        stage('order-service') {
          steps {
            container('docker') {
              sh '''
                echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin
                
                # Pull DEV image
                docker pull ${DOCKERHUB_REPO}/order-service:${DEV_IMAGE_TAG}
                
                # Re-tag to STAGE
                docker tag ${DOCKERHUB_REPO}/order-service:${DEV_IMAGE_TAG} ${DOCKERHUB_REPO}/order-service:${STAGE_TAG}
                
                # Push STAGE image
                docker push ${DOCKERHUB_REPO}/order-service:${STAGE_TAG}
                
                docker logout
              '''
            }
          }
        }
        stage('payment-service') {
          steps {
            container('docker') {
              sh '''
                echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin
                docker pull ${DOCKERHUB_REPO}/payment-service:${DEV_IMAGE_TAG}
                docker tag ${DOCKERHUB_REPO}/payment-service:${DEV_IMAGE_TAG} ${DOCKERHUB_REPO}/payment-service:${STAGE_TAG}
                docker push ${DOCKERHUB_REPO}/payment-service:${STAGE_TAG}
                docker logout
              '''
            }
          }
        }
        stage('shipping-service') {
          steps {
            container('docker') {
              sh '''
                echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin
                docker pull ${DOCKERHUB_REPO}/shipping-service:${DEV_IMAGE_TAG}
                docker tag ${DOCKERHUB_REPO}/shipping-service:${DEV_IMAGE_TAG} ${DOCKERHUB_REPO}/shipping-service:${STAGE_TAG}
                docker push ${DOCKERHUB_REPO}/shipping-service:${STAGE_TAG}
                docker logout
              '''
            }
          }
        }
      }
    }

    stage('Deploy to STAGE') {
      steps {
        container('kubectl') {
          script {
            echo "=== Deploying to ecommerce-stage namespace ==="
            
            // Update deployments with STAGE tag
            sh """
              kubectl set image deployment/order-service \
                order-service=${DOCKERHUB_REPO}/order-service:${STAGE_TAG} \
                -n ecommerce-stage
              
              kubectl set image deployment/payment-service \
                payment-service=${DOCKERHUB_REPO}/payment-service:${STAGE_TAG} \
                -n ecommerce-stage
              
              kubectl set image deployment/shipping-service \
                shipping-service=${DOCKERHUB_REPO}/shipping-service:${STAGE_TAG} \
                -n ecommerce-stage
            """
            
            echo "=== Waiting for rollout to complete ==="
            sh """
              kubectl rollout status deployment/order-service -n ecommerce-stage --timeout=10m
              kubectl rollout status deployment/payment-service -n ecommerce-stage --timeout=10m
              kubectl rollout status deployment/shipping-service -n ecommerce-stage --timeout=10m
            """
            
            echo "=== Verifying pods are ready ==="
            sh """
              kubectl wait --for=condition=ready pod -l app=order-service -n ecommerce-stage --timeout=5m
              kubectl wait --for=condition=ready pod -l app=payment-service -n ecommerce-stage --timeout=5m
              kubectl wait --for=condition=ready pod -l app=shipping-service -n ecommerce-stage --timeout=5m
            """
          }
        }
      }
    }

    stage('Run E2E Tests in STAGE') {
      steps {
        container('maven') {
          dir('e2e-tests') {
            sh '''
              # Set API Gateway URL to STAGE namespace
              export API_GATEWAY_URL=http://api-gateway.ecommerce-stage.svc.cluster.local:8080
              
              mvn -B -U clean test
            '''
          }
        }
      }
      post {
        always {
          junit allowEmptyResults: true, testResults: 'e2e-tests/target/surefire-reports/*.xml'
        }
      }
    }

    stage('Run Performance Tests in STAGE') {
      steps {
        container('kubectl') {
          script {
            echo '=== Starting Performance Tests with Locust in STAGE ==='
            
            // Create ConfigMap
            sh '''
              kubectl create configmap locustfile \
                --from-file=locustfile.py \
                --namespace=ecommerce-stage \
                --dry-run=client -o yaml | kubectl apply -f -
            '''
            
            // Delete previous job
            sh 'kubectl delete job locust-performance-test -n ecommerce-stage --ignore-not-found=true'
            sh 'sleep 5'
            
            // Apply performance test job (need to create STAGE version)
            sh '''
              cat k8s/performance-test-job.yaml | \
                sed 's/namespace: ecommerce/namespace: ecommerce-stage/g' | \
                kubectl apply -f -
            '''
            
            // Wait for completion
            sh '''
              kubectl wait --for=condition=complete \
                --timeout=600s \
                job/locust-performance-test -n ecommerce-stage || true
            '''
            
            // Get job status
            def jobStatus = sh(
              script: 'kubectl get job locust-performance-test -n ecommerce-stage -o jsonpath=\'{.status.conditions[0].type}\'',
              returnStdout: true
            ).trim()
            
            echo "Performance Test Job status: ${jobStatus}"
            
            // Get pod name and logs
            def podName = sh(
              script: 'kubectl get pods -n ecommerce-stage -l job-name=locust-performance-test -o jsonpath=\'{.items[0].metadata.name}\'',
              returnStdout: true
            ).trim()
            
            sh "kubectl logs -n ecommerce-stage ${podName} || true"
            
            // Extract reports
            sh """
              kubectl cp ecommerce-stage/${podName}:/reports/performance-report.html \
                ./performance-report-stage.html 2>/dev/null || \
                echo '<html><body><h1>Report not found</h1></body></html>' > performance-report-stage.html
            """
            
            if (jobStatus != 'Complete') {
              echo "WARNING: Performance test job status: ${jobStatus}"
              echo "Continuing pipeline..."
            }
          }
        }
      }
      post {
        always {
          archiveArtifacts artifacts: 'performance-report-stage.html', allowEmptyArchive: true
        }
        cleanup {
          sh 'kubectl delete job locust-performance-test -n ecommerce-stage --ignore-not-found=true || true'
        }
      }
    }

    stage('Tag as STABLE') {
      when {
        expression { 
          currentBuild.result == null || currentBuild.result == 'SUCCESS'
        }
      }
      steps {
        container('docker') {
          sh '''
            echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin
            
            # Pull STAGE images
            docker pull ${DOCKERHUB_REPO}/order-service:${STAGE_TAG}
            docker pull ${DOCKERHUB_REPO}/payment-service:${STAGE_TAG}
            docker pull ${DOCKERHUB_REPO}/shipping-service:${STAGE_TAG}
            
            # Tag as STABLE
            docker tag ${DOCKERHUB_REPO}/order-service:${STAGE_TAG} ${DOCKERHUB_REPO}/order-service:${STABLE_TAG}
            docker tag ${DOCKERHUB_REPO}/payment-service:${STAGE_TAG} ${DOCKERHUB_REPO}/payment-service:${STABLE_TAG}
            docker tag ${DOCKERHUB_REPO}/shipping-service:${STAGE_TAG} ${DOCKERHUB_REPO}/shipping-service:${STABLE_TAG}
            
            # Push STABLE images
            docker push ${DOCKERHUB_REPO}/order-service:${STABLE_TAG}
            docker push ${DOCKERHUB_REPO}/payment-service:${STABLE_TAG}
            docker push ${DOCKERHUB_REPO}/shipping-service:${STABLE_TAG}
            
            docker logout
          '''
        }
      }
    }
  }
  
  post {
    always {
      echo "Build: ${env.BUILD_URL}"
    }
    success {
      echo "✅ STAGE Pipeline completed successfully!"
      echo "Images tagged as:"
      echo "  - ${DOCKERHUB_REPO}/order-service:${STAGE_TAG}"
      echo "  - ${DOCKERHUB_REPO}/payment-service:${STAGE_TAG}"
      echo "  - ${DOCKERHUB_REPO}/shipping-service:${STAGE_TAG}"
      echo ""
      echo "STABLE images ready for PROD:"
      echo "  - ${DOCKERHUB_REPO}/order-service:${STABLE_TAG}"
      echo "  - ${DOCKERHUB_REPO}/payment-service:${STABLE_TAG}"
      echo "  - ${DOCKERHUB_REPO}/shipping-service:${STABLE_TAG}"
      echo ""
      echo "⚠️  To deploy to PRODUCTION, manually trigger 'ecommerce-prod-pipeline'"
      echo "   with STABLE_VERSION=${params.VERSION}"
      
      // OPCIONAL: Trigger automático de PROD (comentado por default debido a approval manual)
      // Descomentar si se quiere flujo completamente automático hasta el approval
      /*
      echo "=== Triggering PROD pipeline (will wait for manual approval) ==="
      build job: 'ecommerce-prod-pipeline',
            wait: false,
            parameters: [
              string(name: 'STABLE_VERSION', value: "${params.VERSION}"),
              booleanParam(name: 'SKIP_APPROVAL', value: false)
            ]
      */
    }
    failure {
      echo "❌ STAGE Pipeline failed!"
      echo "Images NOT tagged as STABLE"
    }
  }
}
